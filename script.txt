(function() {
  const boardSize = 10;
  const board = Array.from({ length: boardSize }, () => Array(boardSize).fill(null));

  // è·å–ç¬¬ x è¡Œ y åˆ—çš„ DOM å…ƒç´ 
  function getTile(x, y) {
    const tiles = document.querySelectorAll('.select-none');
    return tiles[x * boardSize + y] || null;
  }

  // ä»æ ¼å­ class ä¸­è¯»å–æ•°å€¼
  function readTileValue(el) {
    if (!el) return null;
    const classList = el.classList;
    for (let i = 1; i <= 8; i++) {
      if (classList.contains(`text-${i}`)) return i;
    }
    if (classList.contains('tile-flagged')) return 'F'; // æ——å­
    return null;
  }

  // DOM -> board åŒæ­¥
  function syncBoardFromDOM() {
  const tiles = Array.from(document.querySelectorAll('.select-none'));

  // éå†æ‰€æœ‰æ ¼å­å¹¶æ›´æ–°æ£‹ç›˜çŠ¶æ€
  for (let x = 0; x < 10; x++) {
      for (let y = 0; y < 10; y++) {
        const el = tiles[x * 10 + y];
        const text = el.innerText.trim();
        const styleAttr = el.getAttribute('style') || '';

        if (styleAttr.includes('background-color: transparent')) {
          board[x][y] = 0;  // è¿™é‡Œ 0 è¡¨ç¤ºå·²ç‚¹å‡»çš„ç©ºç™½æ ¼
        }
        // å¦åˆ™å°è¯•è¯»å–æ•°å­—
        else if (text !== '' && !isNaN(text)) {
          board[x][y] = parseInt(text);
        } else if (readTileValue(el) === 'F'){
          board[x][y] = 'F';
        } else {
          board[x][y] = null;
        }
      }
    }
  }

  // 8æ–¹å‘è¾…åŠ©
  const dirs = [
    [-1,-1],[0,-1],[1,-1],
    [-1, 0],       [1, 0],
    [-1, 1],[0, 1],[1, 1]
  ];

  // æ‰¾æ‰€æœ‰â€œå®‰å…¨æ ¼å­â€æˆ–â€œåº”è¯¥æ’æ——çš„é›·â€
  function analyzeBoard() {
    const safeClicks = [];
    const toFlag = [];

    for (let x = 0; x < boardSize; x++) {
      for (let y = 0; y < boardSize; y++) {
        const val = board[x][y];
        if (typeof val !== 'number' || val === 0) continue;

        const around = dirs.map(([dx, dy]) => [x + dx, y + dy])
                           .filter(([nx, ny]) => nx >= 0 && nx < boardSize && ny >= 0 && ny < boardSize);
        const unknowns = around.filter(([nx, ny]) => board[nx][ny] === null);
        const flags = around.filter(([nx, ny]) => board[nx][ny] === 'F');

        // å‘¨å›´æœªçŸ¥æ ¼å­æ•° + æ’æ——æ•° === å½“å‰æ•°å­— â†’ è¯´æ˜æœªçŸ¥æ ¼å­éƒ½æ˜¯é›·
        if (unknowns.length > 0 && unknowns.length + flags.length === val) {
          unknowns.forEach(([nx, ny]) => toFlag.push([nx, ny]));
        }

        // æ’æ——æ•° === å½“å‰æ•°å­— â†’ å‰©ä¸‹æœªçŸ¥æ ¼å­å¯å®‰å…¨ç‚¹å‡»
        if (unknowns.length > 0 && flags.length === val) {
          unknowns.forEach(([nx, ny]) => safeClicks.push([nx, ny]));
        }
      }
    }

    return { safeClicks, toFlag };
  }

  function leftClick(el) {
    el.dispatchEvent(new MouseEvent('mousedown', { bubbles: true, cancelable: true, button: 0 }));
    el.dispatchEvent(new MouseEvent('mouseup', { bubbles: true, cancelable: true, button: 0 }));
    el.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, button: 0 }));
  }

  function rightClick(el) {
    el.dispatchEvent(new MouseEvent('contextmenu', { bubbles: true, cancelable: true, button: 2 }));
  }

  const interval = setInterval(() => {
    syncBoardFromDOM();
    console.log("å½“å‰æ£‹ç›˜ï¼š");
    console.log(board);
    const { safeClicks, toFlag } = analyzeBoard();

    if (toFlag.length > 0) {
      toFlag.forEach(([x, y]) => {
        const el = getTile(x, y);
        if (el && board[x][y] === null) {
          console.log(`ğŸš© æ’æ—— [${x}, ${y}]`);
          rightClick(el);
          board[x][y] = 'F'; // æ ‡è®°æœ¬åœ°
        }
      });
    } else if (safeClicks.length > 0) {
      const [x, y] = safeClicks[0];
      const el = getTile(x, y);
      if (el && board[x][y] === null) {
        console.log(`âœ… å®‰å…¨ç‚¹å‡» [${x}, ${y}]`);
        leftClick(el);
      }
    } else {
      // æ— æ³•æ¨ç†æ—¶ï¼Œéšä¾¿ç‚¹ä¸€ä¸ªæœªçŸ¥æ ¼å­ï¼ˆæˆ–åœä¸‹æ¥ï¼‰
      for (let x = 0; x < boardSize; x++) {
        for (let y = 0; y < boardSize; y++) {
          if (board[x][y] === null) {
            const el = getTile(x, y);
            if (el) {
              console.log(`ğŸŒ€ çŒœæµ‹ç‚¹å‡» [${x}, ${y}]`);
              leftClick(el);
              return;
            }
          }
        }
      }

      console.log("ğŸ‰ æ²¡æœ‰å¯ä»¥ç‚¹çš„æ ¼å­äº†ï¼Œç»“æŸï¼");
      const btn = [...document.querySelectorAll('button')].find(b => 
        b.innerText.trim().toLowerCase().includes('play again')
      );
      if (btn) {
        btn.click();
       
      } else {
        clearInterval(interval);
      }
    }

  }, 1000);
})();
